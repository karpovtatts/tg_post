# Инструкция по синхронизации канала Telegram

## Быстрый старт

### Шаг 1: Активация виртуального окружения

Откройте терминал PowerShell и выполните:

```powershell
cd "d:\Vibe Coding\tg post\backend"
.\venv\Scripts\activate
```

**Результат:** В начале строки должно появиться `(venv)`

---

### Шаг 2: Запуск синхронизации

В том же терминале выполните:

```powershell
python scripts/sync_channel.py
```

**Что происходит:**
- Скрипт подключается к Telegram через Telethon
- Загружает сообщения из канала
- Сохраняет их в базу данных
- Извлекает текст и изображения (если доступны)

**Время выполнения:** Зависит от количества сообщений (обычно 1-5 минут)

**Важно:** При первом запуске может потребоваться ввод кода подтверждения из Telegram

---

### Шаг 3: Проверка результата

После завершения синхронизации проверьте:

1. **В терминале** должны быть сообщения:
   - `Синхронизация завершена`
   - `Обработано сообщений: X`
   - `Создано новых: Y`
   - `Обновлено: Z`

2. **На сайте** (если запущен frontend):
   - Откройте `http://localhost:5173`
   - Должны отобразиться все синхронизированные посты

---

## Полная инструкция (с запуском серверов)

### Если серверы не запущены

#### 1. Запуск Backend (API)

Откройте **первый терминал** PowerShell:

```powershell
cd "d:\Vibe Coding\tg post\backend"
.\venv\Scripts\activate
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

**Результат:** Должно появиться `Application startup complete`

**Важно:** Backend должен быть запущен перед запуском бота, так как бот подключается к API.

---

#### 2. Запуск Telegram бота (для получения изображений)

Откройте **второй терминал** PowerShell:

```powershell
cd "d:\Vibe Coding\tg post\backend"
.\venv\Scripts\activate
python -m app.bot.main
```

**Результат:** Должно появиться:
- `Запуск Telegram бота для канала -1001969322628`
- `Бот запущен, ожидание сообщений...`

**Что делает бот:**
- Слушает новые посты в канале
- Автоматически сохраняет их в базу данных через API
- Позволяет получать изображения из постов

**Важно:** Бот должен быть добавлен в канал как администратор для работы.

---

#### 3. Запуск Frontend (сайт)

Откройте **третий терминал** PowerShell:

```powershell
cd "d:\Vibe Coding\tg post\frontend"
npm run dev
```

**Результат:** Должно появиться `Local: http://localhost:5173`

---

#### 4. Синхронизация канала (первичная загрузка)

Откройте **четвертый терминал** PowerShell:

```powershell
cd "d:\Vibe Coding\tg post\backend"
.\venv\Scripts\activate
python scripts/sync_channel.py
```

**Когда использовать:**
- Первичная загрузка всех постов из канала
- Обновление данных после длительного перерыва
- После добавления бота в канал (для получения изображений)

---

## Параметры синхронизации

### Синхронизация всех сообщений (по умолчанию)

```powershell
python scripts/sync_channel.py
```

### Синхронизация ограниченного количества

```powershell
python scripts/sync_channel.py --limit 50
```

Синхронизирует только последние 50 сообщений.

---

## Решение проблем

### Ошибка: "Не удалось найти канал"

**Причина:** Неправильный `CHANNEL_ID` в `.env`

**Решение:**
1. Откройте `.env` в корне проекта
2. Проверьте `CHANNEL_ID=-1001969322628`
3. Убедитесь, что ID правильный (формат: `-100...`)

---

### Ошибка: "Модуль telethon не найден"

**Причина:** Виртуальное окружение не активировано или библиотека не установлена

**Решение:**
```powershell
cd "d:\Vibe Coding\tg post\backend"
.\venv\Scripts\activate
pip install -r requirements.txt
```

---

### Ошибка: "BOT_TOKEN не установлен"

**Причина:** Токен бота не указан в `.env`

**Решение:**
1. Откройте `.env` в корне проекта
2. Проверьте `BOT_TOKEN=8210321714:AAHru5DqdG-jNTNcNlvLt-9jBnCGTwB3hRw`
3. Убедитесь, что токен правильный

---

### Изображения не отображаются

**Причина:** Бот не в канале или не имеет доступа к сообщениям

**Важно:** Без бота в канале изображения **НЕ будут сохраняться**. Синхронизация через Telethon работает для текста, но для получения URL изображений нужен бот в канале.

**Решение:**

#### Вариант 1: Добавить бота в канал (рекомендуется)

1. **Узнайте username бота:**
   - Откройте Telegram
   - Найдите бота @BotFather
   - Отправьте команду `/mybots`
   - Выберите вашего бота
   - Там будет указан username (например, `@your_bot`)

2. **Добавьте бота в канал:**
   - Откройте канал в Telegram
   - Перейдите в "Управление каналом" → "Администраторы"
   - Нажмите "Добавить администратора"
   - Найдите вашего бота по username
   - Добавьте бота с правами "Чтение сообщений"

3. **Проверьте BOT_TOKEN в `.env`:**
   - Убедитесь, что `BOT_TOKEN=8210321714:AAHru5DqdG-jNTNcNlvLt-9jBnCGTwB3hRw`
   - Токен должен быть правильным

4. **Перезапустите синхронизацию:**
   ```powershell
   cd "d:\Vibe Coding\tg post\backend"
   .\venv\Scripts\activate
   python scripts/sync_channel.py
   ```

#### Вариант 2: Работать без изображений

Если не хотите добавлять бота в канал, можно работать только с текстом. Изображения не будут отображаться, но все остальное будет работать нормально.

**Как проверить, что бот в канале:**
- После добавления бота в канал, попробуйте переслать любое сообщение из канала боту
- Если пересылка работает - бот в канале
- Если ошибка "chat not found" - бот не в канале

---

## Структура файлов

```
tg post/
├── .env                    # Настройки (токены, ID канала)
├── backend/
│   ├── venv/              # Виртуальное окружение
│   ├── scripts/
│   │   └── sync_channel.py # Скрипт синхронизации
│   └── app/               # Код приложения
└── frontend/              # Интерфейс сайта
```

---

## Часто задаваемые вопросы

### Как часто нужно синхронизировать?

**Ответ:** Зависит от активности канала:
- Активный канал (много постов в день): раз в час
- Обычный канал: раз в день
- Малоподвижный канал: раз в неделю

### Можно ли автоматизировать синхронизацию?

**Ответ:** Да, можно настроить cron (Linux) или Task Scheduler (Windows) для автоматического запуска скрипта.

### Что делать, если синхронизация прервалась?

**Ответ:** Просто запустите скрипт снова. Он автоматически пропустит уже обработанные сообщения (по `tg_message_id`).

### Как узнать, сколько сообщений в базе?

**Ответ:** Откройте сайт `http://localhost:5173` - там будет показано общее количество промптов.

---

## Контакты и поддержка

Если возникли проблемы:
1. Проверьте логи в терминале
2. Убедитесь, что все серверы запущены
3. Проверьте настройки в `.env`

---

**Последнее обновление:** 2026-02-03

